#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

BUILD_DIR=$1
CACHE_DIR=$2

VIPS_VERSION=8.14.2

cd $CACHE_DIR/

# Download VIPS (or get from cache?)
if [ ! -d vips-$VIPS_VERSION ]; then
    wget "https://github.com/libvips/libvips/releases/download/v$VIPS_VERSION/vips-$VIPS_VERSION.tar.xz" -O vips-$VIPS_VERSION.tar.xz
    tar -xvf vips-$VIPS_VERSION.tar.xz
fi
cd vips-$VIPS_VERSION

# Compile VIPS and store in in vendor/vips
./configure --prefix $1/vendor/vips
make
make install

# Preparing runtime environment
mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=\$PATH:/app/vendor/vips/bin" > $BUILD_DIR/.profile.d/vips.sh
echo "export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:/app/vendor/vips/lib" >> $BUILD_DIR/.profile.d/vips.sh
echo "export LIBRARY_PATH=\$LD_LIBRARY_PATH:/app/vendor/vips/lib" >> $BUILD_DIR/.profile.d/vips.sh