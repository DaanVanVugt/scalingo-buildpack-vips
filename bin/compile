#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

BUILD_DIR=$1

mkdir $BUILD_DIR/tmp-vips
cd $BUILD_DIR/tmp-vips

# Download VIPS
wget "https://github.com/libvips/libvips/releases/download/v8.12.1/vips-8.12.1.tar.gz" -O vips.tar.gz
tar -xvf vips.tar.gz
cd vips-8.12.1

# Compile VIPS and store in in vendor/vips
./configure --prefix $1/vendor/vips
make
make install

# Preparing runtime environment
mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=\$PATH:/app/vendor/vips/bin" > $BUILD_DIR/.profile.d/vips.sh
echo "export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:/app/vendor/vips/lib" >> $BUILD_DIR/.profile.d/vips.sh
echo "export LIBRARY_PATH=\$LD_LIBRARY_PATH:/app/vendor/vips/lib" >> $BUILD_DIR/.profile.d/vips.sh